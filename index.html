<html>

<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>

  <style>
    body {
      font-family: sans-serif;
    }

    #choropleth_dep {
      outline: 5px solid rgb(180, 223, 230);
      grid-column: 1;
      margin: auto;
      border-radius: 20px;
    }

    #choropleth_change {
      outline: 5px solid rgb(180, 223, 230);
      grid-column: 1;
      margin: auto;
      border-radius: 20px;
    }

    #graph2 {
      outline: 5px solid rgb(180, 223, 230);
      grid-column: 2;
      margin: auto;
      border-radius: 20px;
    }

    #graph2 {
      outline: 5px solid rgb(180, 223, 230);
      border-radius: 20px;
    }

    .outline {
      fill: none;
      stroke: rgb(255, 255, 255);
      stroke-width: 2px;
    }

    .wrapper {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .data-sel {
      margin-top: auto;
      margin-bottom: auto;
      margin-left: 2px;
      margin-right: 2px;
      background-color: rgb(180, 223, 230);
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      height: 80px;
      flex: 1;
      border-radius: 20px;
    }

    .data-sel:hover {
      background-color: rgb(43, 124, 217);
    }

    .active-sel {
      background-color: rgb(130, 179, 236);
    }

    .dep-title {
      text-align: center;
      grid-column: 1;
      margin: auto;
      font-family: sans-serif;
    }

    .change-title {
      text-align: center;
      grid-column: 1;
      margin: auto;
      font-family: sans-serif;
    }

    .chart-title {
      text-align: center;
      grid-column: 2;
      margin: auto;
    }

    .overall-title {
      grid-column: 1 / 3;
      margin: auto;
      font-size: 70;
      color: rgb(130, 179, 236);
    }

    .title-description {
      font-size: 15;
      grid-column: 1/3;
      margin: auto;
      text-align: center;
      margin-bottom: 20px;
    }

    .buttons {
      display: flex;
      flex-wrap: wrap;
      max-width: 654px;
      grid-column: 2;
      margin: 0 auto;
      justify-content: space-between;
    }

    .grid line {
      stroke: #e6e6e6;
    }

    .column {
      margin: auto;
    }
  </style>
</head>

<body>

  <div class="wrapper">

    <div class="column">
      <h1 id="depMap" class="dep-title">US Depression Rates</h1>
      <svg id="choropleth_dep" height="250" width="650"
        style="background: rgb(255, 255, 255); margin-bottom:25px; margin-top:10px"></svg>
      <h1 id="changeMap" class="change-title">US Average Temperatures</h1>
      <svg id="choropleth_change" height="250" width="650"
        style="background: rgb(255, 255, 255); margin-top:10px"></svg>
    </div>

    <div class="column">
      <h1 id="chartTitle" class="chart-title">Temperature vs. Depression</h1>
      <svg id="graph2" height="475" width="650"
        style="background: rgb(255, 255, 255); margin-bottom:20px; margin-top:10px"></svg>
      <div class="buttons">
        <button id="temperatures" class="data-sel">Average Temperatures (F)</button>
        <button id="sunlight" class="data-sel">Average Sunlight (Hrs)</button>
        <button id="income" class="data-sel">Median Household Income ($)</button>
      </div>
    </div>

    <script>
      const svg_dep = d3.select("#choropleth_dep");
      const svg_change = d3.select("#choropleth_change");

      const width_dep = svg_dep.attr("width");
      const height_dep = svg_dep.attr("height");
      const width_change = svg_change.attr("width");
      const height_change = svg_change.attr("height");

      const margin = { top: 20, right: 20, bottom: 20, left: 20 };

      const mapWidth_dep = width_dep - margin.left - margin.right;
      const mapHeight_dep = height_dep - margin.top - margin.bottom;
      const mapWidth_change = width_change - margin.left - margin.right;
      const mapHeight_change = height_change - margin.top - margin.bottom;

      const map_dep = svg_dep.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
      const map_change = svg_change.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      const stateNum = { 1: "Alabama", 2: "Alaska", 4: "Arizona", 5: "Arkansas", 6: "California", 8: "Colorado", 9: "Connecticut", 10: "Delaware", 12: "Florida", 13: "Georgia", 15: "Hawaii", 16: "Idaho", 17: "Illinois", 18: "Indiana", 19: "Iowa", 20: "Kansas", 21: "Kentucky", 22: "Louisiana", 23: "Maine", 24: "Maryland", 25: "Massachusetts", 26: "Michigan", 27: "Minnesota", 28: "Mississippi", 29: "Missouri", 30: "Montana", 31: "Nebraska", 32: "Nevada", 33: "New Hampshire", 34: "New Jersey", 35: "New Mexico", 36: "New York", 37: "North Carolina", 38: "North Dakota", 39: "Ohio", 40: "Oklahoma", 41: "Oregon", 42: "Pennsylvania", 44: "Rhode Island", 45: "South Carolina", 46: "South Dakota", 47: "Tennessee", 48: "Texas", 49: "Utah", 50: "Vermont", 51: "Virginia", 53: "Washington", 54: "West Virginia", 55: "Wisconsin", 56: "Wyoming" };

      const requestChoroplethData = async function (mode) {
        const us = await d3.json("./data/us.json");
        var states = topojson.feature(us, us.objects.states);
        var statesMesh = topojson.mesh(us, us.objects.states);
        var projection_dep = d3.geoAlbersUsa().fitSize([mapWidth_dep, mapHeight_dep], states);
        var projection_change = d3.geoAlbersUsa().fitSize([mapWidth_change, mapHeight_change], states);

        var path_dep = d3.geoPath().projection(projection_dep);
        var path_change = d3.geoPath().projection(projection_dep);

        //Depression Data Processing
        var depression_data_map = {};
        var depression_individual = [];
        var depression_data_raw = await d3.csv("./data/depression-rates-by-state.csv",
          function (d) {
            depression_data_map[d.numberCode] = d.CrudeDepressionRate;
            depression_individual.push(d.CrudeDepressionRate);
          });
        console.log(depression_data_map)

        //Temperature Data Processing
        var temp_data_map = {};
        var temp_individual = [];
        var temp_data_raw = await d3.csv("./data/average-temperatures-by-state.csv",
          function (d) {
            temp_data_map[d.numberCode] = d.averageTemperatureF;
            temp_individual.push(d.averageTemperatureF);
          });
        console.log(temp_data_map)

        //Sunlight Data Processing
        var sunlight_data_map = {};
        var sunlight_individual = [];
        var sunlight_data_raw = await d3.csv("./data/sunniest-states.csv",
          function (d) {
            sunlight_data_map[d.numberCode] = d.averageAnnualSunlight;
            sunlight_individual.push(d.averageAnnualSunlight);
          });
        console.log(sunlight_data_map)

        //Income Data Processing
        var income_data_map = {};
        var income_individual = [];
        var income_data_raw = await d3.csv("./data/median-household-income-by-state.csv",
          function (d) {
            income_data_map[d.numberCode] = d.medianHouseholdIncome2021;
            income_individual.push(d.medianHouseholdIncome2021);
          });
        console.log(income_data_map)

        var colorQuintiles = ["#6efad7", "#00d5e8", "#00abf7", "#0079ee", "#5536bb"];//['#bfe7ff', '#82c7f2', '#3ab4e1', '#6bc9aa', '#00c0a0'];
        const temp_color_scale = d3.scaleQuantile().domain(temp_individual).range(colorQuintiles);
        const depression_color_scale = d3.scaleQuantile().domain(depression_individual).range(colorQuintiles);
        const sunlight_color_scale = d3.scaleQuantile().domain(sunlight_individual).range(colorQuintiles);
        const income_color_scale = d3.scaleQuantile().domain(income_individual).range(colorQuintiles);

        let statePaths_dep = map_dep.selectAll("path.state")
          .data(states.features)
          .join("path")
          .attr("class", "state")
          .attr("note", d => d.id)
          .attr("d", path_dep)
          .attr("fill", function (d) {
            return depression_color_scale(depression_data_map[d.id]);
          })

        let statePaths_change = map_change.selectAll("path.state")
          .data(states.features)
          .join("path")
          .attr("class", "state")
          .attr("note", d => d.id)
          .attr("d", path_change)
          .attr("fill", function (d) {
            if (mode == 1) {
              return temp_color_scale(temp_data_map[d.id]);
            }
            else if (mode == 2) {
              return sunlight_color_scale(sunlight_data_map[d.id]);
            }
            else if (mode == 3) {
              return income_color_scale(income_data_map[d.id]);
            }
          })

        map_dep.append("path")
          .datum(statesMesh)
          .attr("class", "outline")
          .attr("d", path_dep);

        map_change.append("path")
          .datum(statesMesh)
          .attr("class", "outline")
          .attr("d", path_change);


        let tooltipWidth = 100;
        let tooltipHeight = 25;

        const depressionMesh = map_dep.append("path")
          .attr("class", "depression-mesh")
          .style("stroke", "none")
          .style("fill", "none");

        let tooltip1 = map_dep.append("g")
          .attr("class", "tooltip1")
          .attr("visibility", "hidden");

        tooltip1.append("rect")
          .attr("fill", "black")
          .attr("opacity", 0.5)
          .attr("y", 0)
          .attr("width", tooltipWidth)
          .attr("height", tooltipHeight)
          .attr("rx", 10);

        tooltip1.append("text")
          .attr("fill", "white")
          .attr("text-anchor", "middle")
          .attr("alignment-baseline", "hanging")
          .attr("x", 0)
          .attr("y", 8)
          .attr("id", "depression-text");

        const changeMesh = map_change.append("path")
          .attr("class", "change-mesh")
          .style("stroke", "none")
          .style("fill", "none");

        let tooltip2 = map_change.append("g")
          .attr("class", "tooltip2")
          .attr("visibility", "hidden");

        tooltip2.append("rect")
          .attr("fill", "black")
          .attr("opacity", 0.5)
          .attr("y", 0)
          .attr("width", tooltipWidth)
          .attr("height", tooltipHeight)
          .attr("rx", 10);

        tooltip2.append("text")
          .attr("fill", "white")
          .attr("text-anchor", "middle")
          .attr("alignment-baseline", "hanging")
          .attr("x", 0)
          .attr("y", 8)
          .attr("id", "change-text");


        map_dep.selectAll("path.state")
          .on("mouseover", function (event, d) {
            const depression_val = depression_data_map[d.id]
            console.log(depression_val)

            tooltip1.style("visibility", "visible")

            const [x, y] = d3.pointer(event);

            var xPos = x;
            var yPos = y - 25;

            tooltip1.select("#depression-text")
              .text(`${stateNum[d.id]}: ${depression_val}`);

            const textElement = tooltip1.select("#depression-text");
            const textBoundingBox = textElement.node().getBBox();
            const tooltipWidth = textBoundingBox.width + 20;

            if (xPos + tooltipWidth > width_dep) {
              console.log(xPos);
              xPos -= tooltipWidth;
              console.log(xPos);
            }

            tooltip1.attr("transform", `translate(${xPos},${yPos})`);

            tooltip1.select("rect")
              .attr("width", tooltipWidth)
              .attr("height", tooltipHeight);

            textElement
              .attr("x", tooltipWidth / 2)

            depressionMesh.attr("d", path_dep(d))
              .style("stroke", "darkblue")
              .style("stroke-width", 3);

          })
          .on("mouseout", function () {
            tooltip1.style("visibility", "hidden");
            depressionMesh.style("stroke", "none").style("stroke-width", 0);

          });


        map_change.selectAll("path.state")
          .on("mouseover", function (event, d) {
            const temp_val = temp_data_map[d.id]
            const sunlight_val = d3.format(",")(sunlight_data_map[d.id])
            const income_val = d3.format(",")(income_data_map[d.id])

            tooltip2.style("visibility", "visible")

            const [x, y] = d3.pointer(event);

            var xPos = x;
            var yPos = y - 25;

            if (mode == 1) {
              tooltip2.select("#change-text")
                .text(`${stateNum[d.id]}: ${temp_val} \u00B0F`);
            }
            else if (mode == 2) {
              tooltip2.select("#change-text")
                .text(`${stateNum[d.id]}: ${sunlight_val} Hrs`);
            }
            else if (mode == 3) {
              tooltip2.select("#change-text")
                .text(`${stateNum[d.id]}: $${income_val}`);
            }

            const textElement = tooltip2.select("#change-text");
            const textBoundingBox = textElement.node().getBBox();
            const tooltipWidth = textBoundingBox.width + 20; // Add some padding

            if (xPos + tooltipWidth > width_dep) {
              console.log(xPos);
              xPos -= (tooltipWidth + 25);
              console.log(xPos);
            }

            tooltip2.attr("transform", `translate(${xPos},${yPos})`);

            tooltip2.select("rect")
              .attr("width", tooltipWidth) // Set the calculated width
              .attr("height", tooltipHeight);

            textElement
              .attr("x", tooltipWidth / 2) // Center the text in the tooltip


            changeMesh.attr("d", path_change(d))
              .style("stroke", "darkblue")
              .style("stroke-width", 3);

          })
          .on("mouseout", function () {
            tooltip2.style("visibility", "hidden");
            changeMesh.style("stroke", "none").style("stroke-width", 0);

          });


      }

      const svg2 = d3.select("svg#graph2");
      const width2 = svg2.attr("width");
      const height2 = svg2.attr("height");
      const margin2 = { top: 40, right: 40, bottom: 50, left: 50 };
      const chartWidth = width2 - margin2.left - margin2.right;
      const chartHeight = height2 - margin2.top - margin2.bottom;

      let annotations = svg2.append("g").attr("id", "annotations");
      let chartArea = svg2.append("g").attr("id", "points")
        .attr("transform", `translate(${margin2.left},${margin2.top})`);

      function calculatePearsonCorrelation(xValues, yValues) {

        // Calculate the means of x and y
        const xMean = xValues.reduce((acc, x) => acc + x, 0) / xValues.length;
        const yMean = yValues.reduce((acc, y) => acc + y, 0) / yValues.length;

        // Calculate the sums of the products and squared deviations
        let sumOfProducts = 0;
        let sumOfSquaredDeviationsX = 0;
        let sumOfSquaredDeviationsY = 0;

        for (let i = 0; i < xValues.length; i++) {
          const deviationX = xValues[i] - xMean;
          const deviationY = yValues[i] - yMean;

          sumOfProducts += deviationX * deviationY;
          sumOfSquaredDeviationsX += deviationX ** 2;
          sumOfSquaredDeviationsY += deviationY ** 2;
        }

        // Calculate the Pearson correlation coefficient
        const r = sumOfProducts / (Math.sqrt(sumOfSquaredDeviationsX) * Math.sqrt(sumOfSquaredDeviationsY));
        return r;
      }


      const requestChartData = async function (mode) {
        
        //Depression Data Processing
        var depression_data_map = {};
        var depression_individual = [];
        var depression_data_raw = await d3.csv("./data/depression-rates-by-state.csv",
          function (d) {
            depression_data_map[d.numberCode] = d.CrudeDepressionRate;
            depression_individual.push(d.CrudeDepressionRate);
          });

        //Temperature Data Processing
        var temp_data_map = {};
        var temp_individual = [];
        var temp_data_raw = await d3.csv("./data/average-temperatures-by-state.csv",
          function (d) {
            temp_data_map[d.numberCode] = d.averageTemperatureF;
            temp_individual.push(d.averageTemperatureF);
          });

        //Sunlight Data Processing
        var sunlight_data_map = {};
        var sunlight_individual = [];
        var sunlight_data_raw = await d3.csv("./data/sunniest-states.csv",
          function (d) {
            sunlight_data_map[d.numberCode] = d.averageAnnualSunlight;
            sunlight_individual.push(d.averageAnnualSunlight);
          });
        console.log(sunlight_data_map)

        //Income Data Processing
        var income_data_map = {};
        var income_individual = [];
        var income_data_raw = await d3.csv("./data/median-household-income-by-state.csv",
          function (d) {
            income_data_map[d.numberCode] = d.medianHouseholdIncome2021;
            income_individual.push(d.medianHouseholdIncome2021);
          });
        console.log(income_data_map)

        const xScale = d3.scaleLinear()
          .domain([d3.min(depression_individual) - 1, d3.max(depression_individual) + 1])
          .range([0, chartWidth]);

        var selectedMap;
        var selectedInd;

        if (mode == 1) {
          selectedMap = temp_data_map;
          selectedInd = temp_individual;
        }
        else if (mode == 2) {
          selectedMap = sunlight_data_map;
          selectedInd = sunlight_individual
        }
        else if (mode == 3) {
          selectedMap = income_data_map;
          selectedInd = income_individual
        }

        const yScale = d3.scaleLinear()
          .domain([d3.min(selectedInd), d3.max(selectedInd)])
          .range([chartHeight, 0]);

        chartArea.append("g")
          .attr("class", "grid")
          .call(d3.axisLeft(yScale).tickSize(-chartWidth).tickFormat(""))
          .call(g => g.select(".domain").remove())
          .call(g => g.selectAll(".tick:not(:first-of-type) line").attr("stroke-opacity", 0.5));

        chartArea.append("g")
          .attr("class", "grid")
          .call(d3.axisBottom(xScale).tickSize(chartHeight).tickFormat(""))
          .call(g => g.select(".domain").remove())
          .call(g => g.selectAll(".tick:not(:first-of-type) line").attr("stroke-opacity", 0.5));

        chartArea.append("g")
          .attr("transform", `translate(0, ${chartHeight})`)
          .call(d3.axisBottom(xScale));

        chartArea.append("g")
          .call(d3.axisLeft(yScale));

        var xValues = [];
        var yValues = [];

        for (const key in depression_data_map) {
          if (selectedMap[key]) {
            const depressionValue = depression_data_map[key];
            const tempValue = selectedMap[key];

            const dataPoint = { x: depressionValue, y: tempValue };

            xValues.push(parseFloat(selectedMap[key]))
            yValues.push(parseFloat(depression_data_map[key]))

            chartArea.append("circle")
              .attr("cx", xScale(dataPoint.x))
              .attr("cy", yScale(dataPoint.y))
              .attr("r", 4)
              .attr("fill", "#7cf7d0")
              .attr("data-name", stateNum[key])

            console.log(dataPoint)

          }

        }

        const correlationCoefficient = calculatePearsonCorrelation(xValues, yValues);

        const legend = chartArea.append("g")
          .attr("class", "legend")

        legend.append("rect")
          .attr("x", 20)
          .attr("y", 325)
          .attr("width", 220)
          .attr("height", 34)
          .attr("fill", "black")
          .attr("opacity", "0.5")
          .attr("rx", "10");

        legend.append("text")
          .attr("fill", "white")
          .attr("x", 20 + 110)
          .attr("y", 325 + 17)
          .attr("text-anchor", "middle") // Center the text horizontally
          .attr("alignment-baseline", "middle")
          .text("Pearson Correlation: " + d3.format(".3f")(correlationCoefficient));

        let tooltip3Width = 100;
        let tooltip3Height = 25;

        let tooltip3 = chartArea.append("g")
          .attr("class", "tooltip3")
          .attr("visibility", "hidden");

        tooltip3.append("rect")
          .attr("fill", "black")
          .attr("opacity", 0.5)
          .attr("y", 0)
          .attr("width", tooltip3Width)
          .attr("height", tooltip3Height)
          .attr("rx", 10);

        tooltip3.append("text")
          .attr("fill", "white")
          .attr("text-anchor", "middle")
          .attr("alignment-baseline", "hanging")
          .attr("x", 0)
          .attr("y", 8)
          .attr("id", "scatter-label");

        chartArea.selectAll("circle")
          .on("mouseover", function (event, d) {
            const point = d3.select(this);
            point.raise();
            point.attr("r", 8)
              .attr("fill", "#4d75f0");

            tooltip3.style("visibility", "visible")

            var xPos = parseFloat(point.attr("cx")) + 5;
            var yPos = parseFloat(point.attr("cy")) - 30;

            tooltip3.select("#scatter-label")
              .text(`${point.attr("data-name")}`);

            const textElement = tooltip3.select("#scatter-label");
            const textBoundingBox = textElement.node().getBBox();
            const tooltip3Width = textBoundingBox.width + 20;

            if (xPos + tooltip3Width > width2 - 50) {
              console.log(xPos);
              xPos -= (tooltip3Width + 10);
              console.log(xPos);
            }

            tooltip3.attr("transform", `translate(${xPos},${yPos})`);

            tooltip3.select("rect")
              .attr("width", tooltip3Width)
              .attr("height", tooltip3Height);

            textElement
              .attr("x", tooltip3Width / 2)

          })
          .on("mouseout", function () {
            tooltip3.style("visibility", "hidden");
            const point = d3.select(this);
            point.attr("r", 4)
              .attr("fill", "#7cf7d0");
          });

      }

      function clearChart() {
        chartArea.selectAll("circle").remove();
        chartArea.selectAll(".grid").remove();
        chartArea.selectAll("g").remove();
      }

      d3.select("#temperatures").on("click", function (event) {
        clearChart();
        requestChartData(1)
        d3.selectAll('.data-sel').classed('active-sel', false);
        d3.select(this).classed('active-sel', true);
        requestChoroplethData(1)
        d3.select('#changeMap')
          .text('US Average Temperatures')
        d3.select('#chartTitle')
          .text('Temperature vs. Depression')
        d3.selectAll('.data-sel').classed('active-sel', false);
        d3.select(this).classed('active-sel', true);

      });

      d3.select("#sunlight").on("click", function (event) {
        clearChart();
        requestChartData(2)
        d3.selectAll('.data-sel').classed('active-sel', false);
        d3.select(this).classed('active-sel', true);
        requestChoroplethData(2)
        d3.select('#changeMap')
          .text('US Average Sunlight')
        d3.select('#chartTitle')
          .text('Sunlight vs. Depression')
        d3.selectAll('.data-sel').classed('active-sel', false);
        d3.select(this).classed('active-sel', true);

      });

      d3.select("#income").on("click", function (event) {
        clearChart();
        requestChartData(3)
        d3.selectAll('.data-sel').classed('active-sel', false);
        d3.select(this).classed('active-sel', true);
        requestChoroplethData(3)
        d3.select('#changeMap')
          .text('US Median Income')
        d3.select('#chartTitle')
          .text('Income vs. Depression')
        d3.selectAll('.data-sel').classed('active-sel', false);
        d3.select(this).classed('active-sel', true);

      });

      d3.select("#temperatures").classed('active-sel', true);
      d3.select("#temperatures").classed('active-sel', true);
      clearChart();
      requestChoroplethData(1);
      requestChartData(1);

    </script>

  </div>



</body>


</html>